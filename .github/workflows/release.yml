name: Publish Release

on:
  push:
    tags:
      - "v*" # å½“æ¨é€ä»¥ "v" å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0, v2.1.0ï¼‰

jobs:
  create-release:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      # Step 1: æ£€å‡ºä»£ç åº“
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: è‡ªåŠ¨ç”Ÿæˆ Release Notes
      - name: Generate release notes
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: |
            categories:
              - title: 'ğŸš€ æ–°åŠŸèƒ½'
                labels:
                  - 'feat'
                  - 'feature'
              - title: 'ğŸ› Bugä¿®å¤'
                labels:
                  - 'fix'
                  - 'bugfix'
              - title: 'ğŸ“š æ–‡æ¡£æ›´æ–°'
                labels:
                  - 'docs'
                  - 'documentation'
              - title: 'âš¡ æ€§èƒ½ä¼˜åŒ–'
                labels:
                  - 'perf'
                  - 'performance'
              - title: 'ğŸ”§ å…¶ä»–æ”¹è¿›'
                labels:
                  - 'chore'
                  - 'refactor'
            template: |
              ## æ›´æ–°å†…å®¹

              #{{CHANGELOG}}

              **å®Œæ•´å˜æ›´**: #{{UNCATEGORIZED}}
            pr_template: |
              - #{{TITLE}} by @#{{AUTHOR}} in ##{{NUMBER}}
            empty_template: |
              - åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
            transformers:
              - pattern: '(feat|fix|docs|perf|chore|refactor)(\(.+\))?: (.+)'
                target: '- $3'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: è‡ªåŠ¨ç”Ÿæˆ Release
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "Api-Conversion ${{ github.ref_name }}"
          body: |
            ## ğŸš€ Api-Conversion ${{ github.ref_name }}
            
            å¤šæ¸ é“AI APIç»Ÿä¸€è½¬æ¢ä»£ç†ç³»ç»Ÿæ–°ç‰ˆæœ¬å‘å¸ƒï¼
            
            ### ğŸ“¦ Docker é•œåƒ
            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ```
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            ${{ steps.changelog.outputs.changelog }}
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }})
            - [Dockeré•œåƒ](https://github.com/${{ github.repository }}/pkgs/container/api-conversion)
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}

      # Step 4: æ„å»ºå‘å¸ƒæ–‡ä»¶
      - name: Create release archive
        run: |
          # ä½¿ç”¨ git archive åŸºäº .gitignore è‡ªåŠ¨æ’é™¤æ–‡ä»¶
          # åŒ…å«æ‰€æœ‰è¢« Git è·Ÿè¸ªçš„æ–‡ä»¶ï¼ˆåŒ…æ‹¬ images/ å’Œ .gitignoreï¼‰
          git archive --format=zip --prefix=api-conversion-${{ github.ref_name }}/ \
            --output=api-conversion-${{ github.ref_name }}.zip HEAD
          
          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
          echo "ğŸ“¦ ç”Ÿæˆçš„å‘å¸ƒåŒ…å†…å®¹ï¼š"
          unzip -l api-conversion-${{ github.ref_name }}.zip | head -20
               
      # Step 5: ä¸Šä¼ å‘å¸ƒæ–‡ä»¶
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./api-conversion-${{ github.ref_name }}.zip
          asset_name: api-conversion-${{ github.ref_name }}.zip
          asset_content_type: application/zip